---
output: 
  word_document:
    keep_md: yes
    reference_docx: "StckAssess-format2.docx"
params: 
  name: "sablefish"
  name_cap: "Sablefish"
  cas: 710
  obs: 203
  chapter: "19"
  appendix: "A"
---
## Appendix `r params$chapter`.`r params$appendix` Observer Coverage and Sampling of the `r params$name_cap` Stock



$$
\textbf{Cindy Tribuzio, Cara Rodgveller, Matt Callahan}
$$

$$
\textbf{`r Sys.Date()`}
$$


# Introduction

This report provides total catch estimates from the Alaska Regional Office Catch Accounting System (CAS), based on landings, fishery observations, and other data sources. Fishery observations and biological samples are collected by the North Pacific Groundfish Observer Program and the Alaska Fisheries Science Center (AFSC) Fishery Monitoring and Analysis program (FMA). A description of the observer strata is in the “Additional Information” section at the end of this document. More details are available in the North Pacific Groundfish Observer Program Annual Deployment Plans and Annual Reports produced by the FMA. All CAS and observer data were queried through the AKFIN database.  

The goals of this report are to present how much of the `r params$name` stock catch was observed by the North Pacific Observer Program and how many biological samples were collected by observers by Fishery Management Plan Subareas and gear types. The total catch of the stock by area and gear is reported in Figure 1 and Table 1. First, the vessel is assigned to an observer stratum in the Observer Deployment and Declare System (ODDS). Figure 3  summarizes how much catch was from trips assigned to each observer stratum, including partial coverage, electronic monitoring (EM) partial coverage, full coverage, or no coverage. This is a representation of how much catch was attributed to trips in each stratum in ODDS and not how much catch was actually observed.   

Table XX  summarizes how much of the catch was actually covered by observers or EM, as a percent of total catch. To see the actual catch with observer and EM coverage and the proportions of the catch with coverage in more detail, Figure 4 includes the coverage by gear type and area. The proportions for each cell are calculated using the catch by coverage type divided by the total catch in each area/grid cell annually. In other words, the proportions are the values in each catch column scaled to sum to 1.  

Lengths and otoliths are collected at-sea and in ports and the rate of collection depends on the gear and area, which is often associated with different regional fisheries (see Figure 9 for length collections). The total counts of fish sampled for lengths and otoliths are presented in Figures 5 and 6 and Tables 2 and 3. A brief summary for the stock is in Table XX. The proportion of these samples in each gear type may fluctuate through time and by area (Figures 5 and 6; Tables 2 and 3). The count of lengths and otoliths can be used with the catch to evaluate the sampling rate, by dividing the number of lengths or otoliths by the catch (e.g., lengths/mt) (Figures 7 and 8, respectively). This rate can be used to evaluate if the absolute number of biological samples has changed in line with the rate of sampling. For example, the number of lengths collected could be decreasing over time, but if the catch is also decreasing the rate may be stable. In Figure 10 the proportion of catch observed using EM (EM mt/total catch mt) is plotted alongside the sampling rate of lengths (lengths/mt), which cannot be collected with only EM.


```{r load-packages, include=FALSE}
library(tidyverse)
library(odbc)
library(getPass)
library(lubridate)
library(janitor)
library(gridExtra)
library(flextable)
library(patchwork)

#This avoids scientific notation on plots
options(scipen = 999)
```

```{r connect-to-akfin, include=FALSE}

#connect to AKFIN
con <- dbConnect(odbc::odbc(), "akfin", UID=getPass(msg="USER NAME"), PWD=getPass())
```

```{r query-cas, include=FALSE}
# define time
startyear<-2013
endyear<-year(ymd(Sys.Date()))-1

#pull catch data
casdat<- dbFetch(dbSendQuery(con,
                           paste0("select year, week_end_date, wed, fmp_area,	fmp_subarea, reporting_area_code, agency_gear_code,
                       trip_target_group, trip_target_name, species_group_name, species_name, processor_permit_id,
                       ito_company processor_name, ito_plant processor_plant, ves_akr_adfg, ves_akr_name,	ves_akr_length,
                       retained_or_discarded, gf_harvest_sector, deployment_trip_start_date,	deployment_trip_end_date,
                       deployment_trip_pk, monitoring_status,	sampling_strata_deployment_category, sampling_strata,
                       sampling_strata_name, sampling_strata_selection_rate, management_program_code, sum(weight_posted) catch_mt
                from council.comprehensive_blend_ca
                where year >= 2013
                and year <= ", endyear, "
                and agency_species_code = '",noquote(params$cas),"'
                and (fmp_area = 'GOA' or fmp_area = 'BSAI')
                group by year, week_end_date, wed, fmp_area,	fmp_subarea, reporting_area_code, agency_gear_code,
                       trip_target_group, trip_target_name, species_group_name, species_name, processor_permit_id,
                       ito_company, ito_plant, ves_akr_adfg, ves_akr_name,	ves_akr_length,
                       retained_or_discarded, gf_harvest_sector, deployment_trip_start_date,	deployment_trip_end_date,
                       deployment_trip_pk, monitoring_status,	sampling_strata_deployment_category, sampling_strata,
                       sampling_strata_name, sampling_strata_selection_rate, management_program_code")))%>%
    clean_names()# %>% 
  #   group_by(year, week_end_date, wed, fmp_area,	fmp_subarea, reporting_area_code, agency_gear_code,
  #          trip_target_group, trip_target_name, species_group_name, species_name, processor_permit_id,
  #          processor_name, processor_plant, ves_akr_adfg, ves_akr_name,	ves_akr_length,
  #          retained_or_discarded, gf_harvest_sector, deployment_trip_start_date,	deployment_trip_end_date,
  #          deployment_trip_pk, monitoring_status,	sampling_strata_deployment_category, sampling_strata,
  #          sampling_strata_name, sampling_strata_selection_rate, management_program_code) %>% 
  # summarise(catch_mt = sum(weight_posted))

```

```{r process-cas, include=FALSE}


#process catch data for plotting
casdat <- casdat %>% 
  mutate(week_end_date = ymd(week_end_date),
         gear = agency_gear_code,
         mgmt_area=recode(fmp_subarea, "BS"="BS","AI"="AI","WG"="WGOA", "CG"="CGOA", "WY"="WY", "SE"="EY"),
         # mgmt_area = if_else(fmp_subarea == "BS", "BS",
         #                     if_else(fmp_subarea == "AI", "AI",
         #                             if_else(fmp_subarea == "WG", "WGOA",
         #                                     if_else(fmp_subarea == "CG", "CGOA", "EGOA")))),
         obs_coverage = if_else(sampling_strata_name == "No Selection", "None",
                                if_else(sampling_strata_name == "Full Selection" |
                                          sampling_strata_name == "Trawl EM Full Coverage Selection", "Full",
                                        if_else(sampling_strata_name == "EM Hook-and-Line Trip Selection" |
                                                  sampling_strata_name == "EM Pot Trip Selection" |
                                                  sampling_strata_name == "EM Pot Tender Trip Selection" |
                                                  sampling_strata_name == "Trawl EM Partial Coverage Selection", "EM Partial",
                                                if_else(sampling_strata_name == "Trawl EM Full Coverage Selection", "EM Full", "Partial")))),
         observed = if_else(monitoring_status == "FIXED_GEAR_EM", "Catch Only",
                            if_else(monitoring_status == "NO_MONITORING", "None","Catch/Biologicals")))

         # obs_coverage=recode(sampling_strata_name, "No Selection"="None",
         #                     "Full Selection"="Full", 
         #                     "Trawl EM Full Coverage Selection"="Full",
         #                     "EM Hook-and-Line Trip Selection"="EM Partial", 
         #                     "EM Pot Trip Selection"="EM Partial",
         #                     "EM Pot Tender Trip Selection"="EM Partial" ,
         #                     "Trawl EM Partial Coverage Selection"="EM Partial",
         #                     "Trawl EM Full Coverage Selection" = "EM Full", 
         #                     "Pot Trip Selection" = "Partial",
         #                     ),

#set plotting orders
casdat$mgmt_area <- factor(casdat$mgmt_area, 
                               levels = c("AI", "BS", "WGOA", "CGOA", "WY", "EY"))
casdat$gear <- factor(casdat$gear, 
                               levels = c("PTR", "NPT", "POT", "HAL", "JIG"))

```

```{r query-norpac-length, include=FALSE}
#pull obs length data
#pull catch data
norln<- dbFetch(dbSendQuery(con,
                           paste0("select species, nmfs_area,  year, akr_gear, fmp_area, fmp_subarea, sampling_strata_name, monitoring_status, sum(frequency) n_length
                from NORPAC.debriefed_length_mv
                where YEAR >= 2013
                 and year <= ", endyear, "
                and FMP_AREA in ('GOA','BSAI')
                and SPECIES = '",noquote(params$obs),"'
                group by species, nmfs_area,  year, akr_gear, fmp_area, fmp_subarea, sampling_strata_name, monitoring_status")))
               

norln <- norln %>% 
  rename_with(tolower) %>%
  #Is there a reason we filtered on nmfs area here and fmp_area for cas?
  #filter(nmfs_area != 649) %>% 
  mutate(gear = akr_gear,
         mgmt_area=recode(fmp_subarea, "BS"="BS","AI"="AI","WG"="WGOA", "CG"="CGOA", "WY"="WY", "SE"="EY"),
         obs_coverage = if_else(sampling_strata_name == "No Selection", "None",
                                if_else(sampling_strata_name == "Full Selection" |
                                          sampling_strata_name == "Trawl EM Full Coverage Selection", "Full",
                                        if_else(sampling_strata_name == "EM Hook-and-Line Trip Selection" |
                                                  sampling_strata_name == "EM Pot Trip Selection" |
                                                  sampling_strata_name == "EM Pot Tender Trip Selection" |
                                                  sampling_strata_name == "Trawl EM Partial Coverage Selection", "EM Partial",
                                                if_else(sampling_strata_name == "Trawl EM Full Coverage Selection", "EM Full", "Partial")))),
         observed = if_else(monitoring_status == "FIXED_GEAR_EM", "Catch Only",
                            if_else(monitoring_status == "NO_MONITORING", "None","Catch/Biologicals")))


#set plotting orders
norln$mgmt_area <- factor(norln$mgmt_area, 
                               levels = c("AI", "BS", "WGOA", "CGOA", "WY", "EY"))
norln$gear <- factor(norln$gear, 
                               levels = c("PTR", "NPT",  "POT", "HAL", "JIG"))

```

```{r query-norpac-age, include=FALSE}
#pull obs length data
norage <- dbFetch(dbSendQuery(con,
                           paste0("
                select join_key, species_key, cruise, permit, vessel, gear, nmfs_area, specimen_number, Type_1_otolith, type_3_sex_length_weight, year,
                       gear_description, akr_gear, fmp_gear, fmp_area, fmp_subarea, species_name, akr_species_codes, deployment_trip_pk,
                       sampling_strata, sampling_strata_name, sampling_strata_deployment_category, sampling_strata_selection_rate, monitoring_status
                from NORPAC.debriefed_age_flat_mv
                where year >= 2013
                 and year <= ", endyear, "
                and species = '",params$obs,"'
                and fmp_area in ('GOA', 'BSAI')"
                ))) %>%
  clean_names()
               

norage <- norage %>% 
  #Is there a reason we filtered on nmfs area here and fmp_area for cas?
  #filter(nmfs_area != 649) %>% 
  mutate(gear = akr_gear,
         mgmt_area=recode(fmp_subarea, "BS"="BS","AI"="AI","WG"="WGOA", "CG"="CGOA", "WY"="WY", "SE"="EY"),
         obs_coverage = if_else(sampling_strata_name == "No Selection", "None",
                                if_else(sampling_strata_name == "Full Selection" |
                                          sampling_strata_name == "Trawl EM Full Coverage Selection", "Full",
                                        if_else(sampling_strata_name == "EM Hook-and-Line Trip Selection" |
                                                  sampling_strata_name == "EM Pot Trip Selection" |
                                                  sampling_strata_name == "EM Pot Tender Trip Selection" |
                                                  sampling_strata_name == "Trawl EM Partial Coverage Selection", "EM Partial",
                                                if_else(sampling_strata_name == "Trawl EM Full Coverage Selection", "EM Full", "Partial")))),
         observed = if_else(monitoring_status == "FIXED_GEAR_EM", "Catch Only",
                            if_else(monitoring_status == "NO_MONITORING", "None","Catch/Biologicals")))


#set plotting orders
norage$mgmt_area <- factor(norage$mgmt_area, 
                               levels = c("AI", "BS", "WGOA", "CGOA", "WY", "EY"))
norage$gear <- factor(norage$akr_gear, 
                               levels = c("PTR", "NPT", "POT", "HAL", "JIG"))

```

\newpage


# Tables

```{r warning=FALSE, message=FALSE, echo=FALSE}
# Note that the report was originally written with figure specific data subsets that were then used for tables. 


#divide into retained and discarded
fig1dat<-casdat %>% 
  filter(retained_or_discarded=="R") %>%
  group_by(year, mgmt_area, gear, retained_or_discarded) %>% 
  summarise(catch_mt = sum(catch_mt)) %>%
  bind_rows(casdat %>% 
  filter(retained_or_discarded=="D") %>%
  group_by(year, mgmt_area, gear, retained_or_discarded) %>% 
  summarise(catch_mt = sum(catch_mt))) %>%
  bind_rows(casdat %>% 
  group_by(year, mgmt_area, gear) %>% 
  summarise(catch_mt = sum(catch_mt)) %>%
    mutate(retained_or_discarded="Both") %>%
    dplyr::select(year, mgmt_area, gear, retained_or_discarded, catch_mt)) %>%
  mutate(retained_or_discarded=recode_factor(retained_or_discarded, "Both"="Total", "R"="Retained", "D"="Discarded"))

#make table of catch by gear and area
fig1sum<-fig1dat %>%
  filter(retained_or_discarded=="Total") %>%
  group_by(mgmt_area, year) %>%
  summarize(Sum=round(sum(catch_mt),0)) %>%
  mutate(Sum=as.character(Sum),
         Sum=recode_factor(Sum, "0"="<1"),
         Sum=as.character(Sum),
         #the next line is that there are commas in the output numbers
         Sum=ifelse(nchar(Sum)<=3, Sum,
                         paste0(substring(Sum, 1, nchar(Sum) - 3),
                          ",",
                          substring(Sum, nchar(Sum) - 2, nchar(Sum)))))

tab1cap<-paste0("Table ", params$chapter, ".", params$appendix, ".1. Total ", params$name, " catch (mt) by area, year, and gear. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")

fig1dat%>%
  filter(retained_or_discarded=="Total") %>%
  mutate(catch_mt=round(catch_mt,0),
         catch_mt=as.character(catch_mt),
         catch_mt=recode_factor(catch_mt, "0"="<1"),
         catch_mt=as.character(catch_mt),
         #the next line is that there are commas in the output numbers
         catch_mt=ifelse(nchar(catch_mt)<=3, catch_mt,
                         paste0(substring(catch_mt, 1, nchar(catch_mt) - 3),
                          ",",
                          substring(catch_mt, nchar(catch_mt) - 2, nchar(catch_mt)))),
         Year=year,
         Area=mgmt_area) %>%
  dplyr::select(Area, Year,  gear, catch_mt) %>%
  pivot_wider(id_cols=c(Area, Year), names_from=gear, values_from=catch_mt) %>%
  left_join(fig1sum, by=c("Area"="mgmt_area", "Year"="year")) %>%
  arrange(Area, Year) %>%
  flextable() %>%
  fontsize(size=11, part="body")%>%
  font(part = "all", fontname = "Times New Roman") %>%
  align(align = "right", part="body") %>%
  align(align = "left", part="head") %>%
  line_spacing(space = 0.3, part = "body")%>%
  add_header_lines(values = tab1cap) %>%
  border(part = "head", i = 1,
         border = list("width" = 0, color = "black", style = "solid"))
  # set_caption(caption=paste0("Table ", params$chapter, ".", params$appendix, ".1. Total ", params$name, " catch (mt) by area, year, and gear. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY)."))

```


\newpage


\newpage

```{r warning=FALSE, message=FALSE, echo=FALSE}
# figure with catch, length, lengths/mt, otolths, otoliths/mt
#number of years
nyears<-length(unique(casdat$year))

#avg catch
tab5_cas_avg<-casdat %>%
  group_by(mgmt_area) %>%
  #calculate average by summing catch and dividing by number of years
  summarize(avg_catch=round((sum(catch_mt)/nyears),0))

#average lengths
tab5_ln_avg<-norln%>%
  group_by(mgmt_area) %>%
  summarize(n_length=round((sum(n_length)/nyears),0)) 

#annual lengths
fig7dat_a <- norln%>%
  group_by(year, mgmt_area) %>%
  summarize(n_length=sum(n_length)) %>% 
  left_join(casdat%>%
              mutate(year=as.numeric(year))%>%
  group_by(year, mgmt_area) %>%
  summarize(catch_mt=sum(catch_mt)),
  by=c("year"="year", "mgmt_area"="mgmt_area"))%>%
  mutate(lratio=n_length/catch_mt)

#annual otoliths
fig8dat_a <- norage%>%
  filter(type_1_otolith=="Y") %>% 
  group_by(year, mgmt_area) %>%
  summarize(n_otolith=n()) %>% 
  left_join(casdat%>%
              mutate(year=as.numeric(year))%>%
  group_by(year, mgmt_area) %>%
  summarize(catch_mt=sum(catch_mt)),
  by=c("year"="year", "mgmt_area"="mgmt_area"))%>%
  mutate(oratio=n_otolith/catch_mt)

# avg otoliths
tab5_oto_avg<-fig8dat_a%>%
  group_by(mgmt_area) %>%
  summarize(avg_oto=round((sum(n_otolith)/nyears),0)) 

#annual totals
tab5dat_ann<-fig7dat_a %>%
  left_join(fig8dat_a%>%
              dplyr::select(!catch_mt), by= c("year"="year", "mgmt_area"="mgmt_area")) %>%
    filter(year %in% (endyear-4):endyear) %>%
  mutate(year=as.character(year))%>%
  dplyr::select(mgmt_area, year, catch_mt, n_length, lratio, n_otolith, oratio)
colnames(tab5dat_ann)=c("Area", "Year", "Catch", "Len", "Len/mt", "Oto", "Oto/mt")



# regional avgs
tab5dat_avg<-tab5_cas_avg%>%
left_join(tab5_ln_avg, by="mgmt_area")%>%
  left_join(tab5_oto_avg, by="mgmt_area") %>%
  mutate(ln_mt=n_length/avg_catch,
         oto_mt=avg_oto/avg_catch,
         year="Avg")%>%
  dplyr::select(mgmt_area, year, avg_catch, n_length, ln_mt, avg_oto, oto_mt)
colnames(tab5dat_avg)=c("Area", "Year", "Catch", "Len", "Len/mt", "Oto", "Oto/mt")
  
#combine
tab5dat<-tab5dat_ann %>%
  bind_rows(tab5dat_avg) %>%
  mutate(Catch=round(Catch,0),
         Len=round(Len,0),
         `Len/mt`=round(`Len/mt`,2),
         Oto=round(Oto,0),
         `Oto/mt`=round(`Oto/mt`,2))


tab5cap<-paste0("Table ", params$chapter, ".", params$appendix, ".2. The total catch in mt for each area and year, the number of individual fish lengths (len) and otoliths (oto) collected, and the rate of length and otolith sampling, as sampling per mt of catch, for the five most recent years and the average from 2013-present. Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")

tab5dat%>%
  arrange(Area)%>%
    flextable() %>%
    fontsize(size=11, part="all")%>%
    line_spacing(space = 0.3, part = "body")%>%
  font(part = "all", fontname = "Times New Roman") %>%
  add_header_lines(values = tab5cap) %>%
    align(align = "right", part="body") %>%
  align(align = "left", part="head") %>%
  border(part = "head", i = 2,
         border = list("width" = 0, color = "black", style = "solid"))
  



```

\newpage

```{r warning=FALSE, message=FALSE, echo=FALSE}
#summarize norpac length data
fig5dat<-norln%>%
  group_by(year, mgmt_area, gear) %>%
  summarize(n_length=sum(n_length))

#summarize without gear calculating proportions
lnsum<-fig5dat %>%
  group_by(mgmt_area, year) %>%
  summarize(Sum=round(sum(n_length),0))

#create table
tab2cap<-paste0("Table ", params$chapter, ".", params$appendix, ".3. Count of  ",params$name, " lengths measured by at-sea and port observers by area, year, and gear. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")

fig5dat%>%
  mutate(Year=year,
         Area=mgmt_area) %>%
  dplyr::select(Area, Year,  gear, n_length) %>%
  pivot_wider(id_cols=c(Area, Year), names_from=gear, values_from=n_length) %>%
   left_join(lnsum, by=c("Area"="mgmt_area", "Year"="year")) %>%
  mutate(Year=as.factor(Year)) %>%
   arrange(Area, Year) %>%
  flextable() %>%
    fontsize(size=11, part="all")%>%
  font(part = "all", fontname = "Times New Roman") %>%
    line_spacing(space = 0.3, part = "body")%>%
    add_header_lines(values = tab2cap) %>%
    align(align = "right", part="body") %>%
  align(align = "left", part="head") %>%
  border(part = "head", i = 1,
         border = list("width" = 0, color = "black", style = "solid"))
  # set_caption(caption=paste0("Table ", params$chapter, ".", params$appendix, ".2. Count of  ",params$name, " lengths measured by at-sea and port observers by area, year, and gear. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY)."))
```



\newpage



```{r warning=FALSE, message=FALSE, echo=FALSE}
#summarize data
fig6dat<-norage%>%
  filter(type_1_otolith=="Y") %>% 
  group_by(year, mgmt_area, gear) %>%
  summarize(n_otolith=n())

#summarize without gear for proportion
osum<-fig6dat %>%
  group_by(mgmt_area, year) %>%
  summarize(Sum=round(sum(n_otolith),0))

#create table
tab3cap<-paste0("Table ", params$chapter, ".", params$appendix, ".4. Count of ",params$name, " otoliths collected at-sea in port by observers by area, year, and gear. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")

fig6dat%>%
  mutate(Year=year,
         Area=mgmt_area) %>%
  dplyr::select(Area, Year,  gear, n_otolith) %>%
  pivot_wider(id_cols=c(Area, Year), names_from=gear, values_from=n_otolith) %>%
  left_join(osum, by=c("Area"="mgmt_area", "Year"="year")) %>%
    mutate(Year=as_factor(Year)) %>%
     arrange(Area, Year) %>%
  flextable() %>%
    fontsize(size=11, part="all")%>%
    line_spacing(space = 0.3, part = "body")%>%
  font(part = "all", fontname = "Times New Roman") %>%
  add_header_lines(values = tab3cap) %>%
    align(align = "right", part="body") %>%
  align(align = "left", part="head") %>%
  border(part = "head", i = 1,
         border = list("width" = 0, color = "black", style = "solid"))
  # set_caption(caption=paste0("Table ", params$chapter, ".", params$appendix, ".3. Count of  ",params$name, " otoliths measured by at-sea and port observers by area, year, and gear. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY)."))

```

\newpage

```{r warning=FALSE, message=FALSE, echo=FALSE}
# .	This data is like the bottom panel of fig 4 (actual coverage of catch - %). Will now have a fig and table.
# THIS TABLE IS NOT FULLY AUTOMATED. GEAR HEADERS NEED TO BE CHECKED (add_header_row flextable functions)

areagear_tot <- casdat %>% 
  filter(gear != "JIG") %>% 
  group_by(year, mgmt_area, gear) %>% 
  summarise(totcatch = sum(catch_mt))

obs_prop <- casdat %>% 
  filter(agency_gear_code != "JIG") %>% 
  group_by(year, mgmt_area, observed, gear) %>% 
  summarise(catch_mt = sum(catch_mt)) %>% 
  inner_join(areagear_tot, by = c("year", "mgmt_area","gear")) %>% 
  mutate(prop_catch = catch_mt/totcatch,
         Coverage = recode(observed, "Catch Only"="EM", "Catch/Biologicals"="Observer", "None"="No Coverage"))

obs_prop$Coverage<- factor(obs_prop$Coverage, levels=c("EM","Observer","No Coverage"))

#create regional averages by gear and area
tab4_area_gear<-obs_prop %>%
  filter(gear!="JIG")%>%
 group_by(mgmt_area, gear) %>%
  summarize(catch_ag=sum(catch_mt))
#create regional avg by gear area, and coverage
tab4_area_gear_cov<-obs_prop %>%
  filter(gear!="JIG")%>%
  group_by(mgmt_area, gear, Coverage) %>%
  summarize(catch_agc=sum(catch_mt))
#create proportions of catch for all years
tab4_sum<-tab4_area_gear_cov%>%
  inner_join(tab4_area_gear, by=c("mgmt_area"="mgmt_area", "gear"="gear")) %>%
  mutate(prop_catch=catch_agc/catch_ag)

#combine with obs_prop
tab4_dat<-tab4_sum%>%
  mutate(year="Avg")%>%
  dplyr::select(year, mgmt_area, gear, prop_catch, Coverage) %>%
  bind_rows(obs_prop%>%
              filter(year %in% (endyear-4):endyear) %>%
              dplyr::select(year, mgmt_area, gear, prop_catch, Coverage))%>%
  mutate(perc_catch=round((prop_catch*100),0))

tab4cap<-paste0("Table ", params$chapter, ".", params$appendix, ".5. The proportion of ", params$name, " catch observed by observers (Obs) or electronic monitoring (EM) by area and gear for the most recent five years and the average proportions from 2013 through the current year. The remainder of the catch had no observer coverage. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")

tab4_dat%>%
  filter(Coverage!="No Coverage")%>%
  mutate(Year=year, Area=mgmt_area)%>%
    pivot_wider(id_cols=c(Area, Year), names_from=c(Coverage, gear), values_from=perc_catch)%>%
  arrange(Area, Year) %>%
  flextable() %>%
  delete_part(part="header") %>%
    fontsize(size=11, part="all")%>%
    line_spacing(space = 0.3, part = "body")%>%
  add_header_row(top = TRUE, values = c("Area", "Year", "% Obs", "% Obs", "% EM", "% Obs", "% EM", "% Obs" )#, colwidths = c(1,3,3)
                 )%>%
  add_header_row(top = TRUE, 
    values = c("", "", "PTR", "NPT", "POT","POT", "HAL", "HAL" )#, colwidths = c(1,3,3)
                 )%>%
  add_header_lines(values = tab4cap) %>%
    align(align = "right", part="body") %>%
  align(align = "left", part="head") %>%
  font(part = "all", fontname = "Times New Roman") %>%
  border(part = "head", i = 2,
         border = list("width" = 0, color = "black", style = "solid"))


```

\newpage

# Figures


```{r fig1, warning=FALSE, message=FALSE, echo=FALSE, fig.width=6, fig.asp=1.2, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".1. ", params$name_cap ," catch by gear type that was either the total of retained  and discarded, retained, or discarded by management area. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}


theme_doc<- function(base_size = 12, base_family = "Arial") { #this function sets the theme for the whole figure
  theme_bw(base_size = base_size, base_family = base_family) %+replace% #also note that this creates a bunch of font warnings that are not a real problem, I just haven't dealt with it yet
#  theme_bw()+
    theme(
      plot.title=element_text(size=12,colour='black',hjust = 0.5, vjust=1),
      plot.background=element_blank(),
      panel.grid = element_blank(),
      panel.grid.minor=element_blank(),
      panel.grid.major.x=element_blank(),
      panel.grid.major.y=element_line(color="grey90"),
      panel.border = element_blank(),
      panel.background = element_blank(),
      axis.line.x = element_line(colour='black'),
      axis.line.y = element_line(colour='black'),
      axis.text=element_text(size=10,colour='black'),
      axis.ticks.y=element_line(colour='black'),
      axis.ticks.x=element_blank(),
      axis.title.y=element_text(colour='black',angle=90, vjust=2.5),
      axis.title.x=element_text(colour='black'),
      legend.background=element_blank(),
      legend.text=element_text(colour='black',size=10),
      legend.title=element_blank(),
      legend.position = "bottom",
      strip.background=element_blank(),
      strip.text=element_text(size=10,colour='black'),
      axis.text.x = element_text(angle = 45, hjust=1, vjust=1.1)
    )
}



#mgmt_colors<-c("#B2282E","#575195","#BC4700","#4C9C2E","#00467f","#1ECAD3")

#gear_colors<-c("#93D500", "#007934","#FF8300", "#0093D0","#7F7FFF")

gear_colors <- c("#440154", "#31688E", "#35B779", "#FDE725","#6EDE76" )

  ggplot(fig1dat, aes(x=as.factor(year), y=catch_mt/1000, 
                               fill = gear, color = gear))+
  geom_bar(position = position_stack(), stat = "identity", show.legend = T, width=1)+
  facet_grid(rows=vars(mgmt_area), cols=vars(retained_or_discarded))+
  labs(x = "Year", y = "Catch (thousand mt)")+
    # scale_fill_viridis_d()+
    # scale_color_viridis_d()+
  scale_color_manual(values=gear_colors)+
  scale_fill_manual(values=gear_colors)+
  #scale_y_continuous(expand = expansion(mult = c(0, 0.05)))+
  scale_y_continuous(n.breaks=5)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  theme_doc()



```


```{r fig2, warning=FALSE, message=FALSE, echo=FALSE, fig.asp=1.2, fig.width=6, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".2. ",params$name_cap," catch in each observer coverage category in the Observer Deploy and Declare System (ODDS), including fixed gear electronic monitoring (EM). This catch was not necessarily observed. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}
#set plotting order
casdat$obs_coverage<-factor(casdat$obs_coverage, levels = c("Partial", "EM Partial", "Full", "None"))

coverage_colors<-c("#625BC4","#FF8300","#4C9C2E","#FF4438")

#filter data
fig3dat<-casdat %>% 
  group_by(year, mgmt_area, obs_coverage, gear) %>% 
  summarise(catch_mt = sum(catch_mt)) %>% 
  inner_join(casdat %>% 
  group_by(year, mgmt_area, gear) %>% 
  summarise(totcatch = sum(catch_mt)), by = c("year", "mgmt_area", "gear")) %>% 
  mutate(prop_catch = catch_mt/totcatch) %>% 
  filter(gear != "JIG")

fig3a <- ggplot(fig3dat, aes(x=as.factor(year), y=catch_mt/1000, fill=obs_coverage, color=obs_coverage))+
  geom_bar(position = position_stack(), stat = "identity", width=1)+
  facet_grid(mgmt_area~gear)+
  labs(x = "Year", y = "Catch (thousand mt)")+
      scale_fill_viridis_d()+
    scale_color_viridis_d()+
  #scale_color_manual(values=coverage_colors)+
  #scale_fill_manual(values=coverage_colors)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 4))+
    scale_y_continuous(n.breaks=5)+
  theme_doc()+
  theme(strip.text.y=element_text(size=10,colour='black', angle=360))

fig3a

  
```


```{r fig3b, warning=FALSE, message=FALSE, echo=FALSE, fig.asp=1.2, fig.width=6, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".3.  Utilizing ",params$name," catch data, the proportions of ",params$name," catch in each observer coverage category in the Observer Deploy and Declare System (ODDS) for each area, gear, and year, including fixed gear electronic monitoring (EM). I.e.,  the catch for each area, gear, and year is scaled to 1. This catch was not necessarily observed. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}


fig3b <- ggplot(fig3dat, aes(x=as.factor(year), y=prop_catch, fill=obs_coverage, color=obs_coverage))+
  geom_bar(position = position_fill(), stat = "identity", width=1)+
  facet_grid(mgmt_area~gear)+
  labs(x = "Year", y = "Proportion")+
      scale_fill_viridis_d()+
    scale_color_viridis_d()+
  scale_y_continuous(breaks=c(0,0.25,0.5,0.75, 1))+
  #scale_color_manual(values=coverage_colors)+
  #scale_fill_manual(values=coverage_colors)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  theme_doc()+
  theme(strip.text.y=element_text(size=10,colour='black', angle=360))

fig3b

  
```


```{r fig4, warning=FALSE, message=FALSE, echo=FALSE, fig.width=6, fig.asp=1.2, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".4. ",params$name_cap," catch by gear type either observed by electronic monitoring (EM), observers, or no coverage. Biological samples were not taken whenever an observer was present. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}
#biol_colors<-c("#625BC4","#AAD7DD","#D02C2F" )
biol_colors<-c("#575195","#1ECAD3","#FF8300")
  
#data definition moved to table 4

fig4a <- ggplot(obs_prop, aes(x=as.factor(year), y=catch_mt/1000, fill=Coverage, color=Coverage))+
  geom_bar(position = position_stack(), stat = "identity", width=1)+
    scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  facet_grid(mgmt_area~gear)+
  labs(x = "Year", y = "Catch (thousand mt)")+
  scale_y_continuous(n.breaks=3)+
        scale_fill_viridis_d()+
    scale_color_viridis_d()+
  # scale_color_manual(values=biol_colors)+
  # scale_fill_manual(values=biol_colors)+
  theme_doc()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.text.y=element_text(size=10,colour='black', angle=360))

fig4a
```


```{r fig5, warning=FALSE, message=FALSE, echo=FALSE, fig.width=6, fig.asp=1.2, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".5. ",params$name_cap," catch by gear type either observed by electronic monitoring (EM), observers, or no coverage. Biological samples were not taken whenever an observer was present. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}
#biol_colors<-c("#625BC4","#AAD7DD","#D02C2F" )


fig4b <- ggplot(obs_prop, aes(x=as.factor(year), y=prop_catch, fill=Coverage, color=Coverage))+
  geom_bar(position = position_stack(), stat = "identity", width=1)+
    scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  facet_grid(mgmt_area~gear)+
  labs(x = "Year", y = "Proportion")+
  scale_y_continuous(breaks=c(0,0.25,0.5,0.75, 1))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  # scale_color_manual(values=biol_colors)+
  # scale_fill_manual(values=biol_colors)+
  theme_doc()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.text.y=element_text(size=10,colour='black', angle=360))

fig4b
```

```{r fig6, warning=FALSE, message=FALSE, echo=FALSE, fig.asp=1.2, fig.width=6, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".6. The number of total lengths collected by observers by gear and area. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}
#plot 

#numbers
fig5_lnum <-ggplot(fig5dat,aes(x=as.factor(year),y=n_length/1000,fill=gear))+
  geom_bar(position="stack", stat="identity")+
  labs(y="Thousands of lengths collected", x = "Year", title="Lengths Collected")+
    scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
    scale_fill_viridis_d()+
  scale_color_viridis_d()+
  #   scale_color_manual(values=gear_colors)+
  # scale_fill_manual(values=gear_colors)+
  facet_grid(mgmt_area~.)+
  theme_doc()+
  theme(legend.position="bottom",
        strip.text.y=element_text(size=10,colour='black', angle=360))
fig5_lnum

```
\newpage
```{r fig7, warning=FALSE, message=FALSE, echo=FALSE, fig.asp=1.2, fig.width=6, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".7. The proportion of lengths collected by observers by gear, area, and year. . I.e., the number of lengths collected for each area, gear, and year are scaled to 1. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}
#plot 


#proportion
fig5_lprop <- ggplot(fig5dat,aes(x=as.factor(year),y=n_length,fill=gear))+
  geom_bar(position="fill", stat="identity")+
  labs(y="Proportion", x = "Year", title="Proportion of Total Lengths")+
  facet_grid(mgmt_area~.)+
    scale_fill_viridis_d()+
  scale_color_viridis_d()+
  #   scale_color_manual(values=gear_colors)+
  # scale_fill_manual(values=gear_colors)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  scale_y_continuous(breaks=c(0,0.25,0.5,0.75, 1))+
  theme_doc()+
  theme(legend.position="bottom",
        strip.text.y=element_text(size=10,colour='black', angle=360))

fig5_lprop

```


```{r fig8, warning=FALSE, message=FALSE, echo=FALSE, fig.asp=1.2, fig.width=6, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".8. The number of otoliths  collected by gear and area. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}

#plot 

#numbers
fig6_anum <-ggplot(fig6dat,aes(x=as.factor(year),y=n_otolith/1000,fill=gear))+
  geom_bar(position="stack", stat="identity")+
  labs(y="Otoliths Collected (thousands)", x = "Year", title="Sampled Otoliths")+
  facet_grid(mgmt_area~.)+
    scale_fill_viridis_d()+
  scale_color_viridis_d()+
  # scale_color_manual(values=gear_colors)+
  # scale_fill_manual(values=gear_colors)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  scale_y_continuous(n.breaks=5)+
  theme_doc()+
    theme(strip.text.y=element_text(size=10,colour='black', angle=360))


fig6_anum

```


```{r fig9, warning=FALSE, message=FALSE, echo=FALSE, fig.asp=1.2, fig.width=6, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".9. The number of otoliths collected by observers and the proportion of ", params$name," otoliths collected by gear and area anbd year. . I.e., the number of otoliths collected for each area, gear, and year are scaled to 1. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}

#plot 

#proportion
fig6_aprop <- ggplot(fig6dat,aes(x=as.factor(year),y=n_otolith,fill=gear))+
  geom_bar(position="fill", stat="identity")+
  labs(y="Proportion", x = "Year", title="Proportion of Total Otoliths")+
  facet_grid(mgmt_area~.)+
    scale_fill_viridis_d()+
  scale_color_viridis_d()+
  # scale_color_manual(values=gear_colors)+
  # scale_fill_manual(values=gear_colors)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  scale_y_continuous(breaks=c(0,0.25,0.5,0.75, 1))+
  theme_doc()+
  theme(legend.position = "bottom",
        strip.text.y=element_text(size=10,colour='black', angle=360))

fig6_aprop

```

```{r fig10, warning=FALSE, message=FALSE, echo=FALSE, fig.width=6, fig.asp=1, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".10. The number of ",  params$name," lengths collected per ton of catch by management area (left) or by gear (right). Note differences in scales. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}

#gear
fig7dat_b <- norln%>%
  group_by(year, gear) %>%
  summarize(n_length=sum(n_length)) %>% 
  left_join(casdat%>%
              mutate(year=as.numeric(year))%>%
  group_by(year, gear) %>%
  summarize(catch_mt=sum(catch_mt)),
  by=c("year"="year", "gear"="gear"))%>%
  mutate(lratio=n_length/catch_mt)


#area
fig7a <-ggplot(fig7dat_a, aes(x=as.factor(year), y=lratio, fill= mgmt_area))+
  geom_bar(position="stack", stat="identity", show.legend=FALSE)+
  labs(y="Number of lengths/mt", x = "Year", title="Lengths/mt by Area")+
  facet_grid(~mgmt_area~., scales="free")+
    scale_fill_viridis_d()+
  scale_color_viridis_d()+
  #   scale_color_manual(values=mgmt_colors)+
  # scale_fill_manual(values=mgmt_colors)+
    scale_y_continuous(n.breaks=3)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  theme_doc()
#gear
fig7b <-ggplot(fig7dat_b, aes(x=as.factor(year), y=lratio, fill= gear))+
  geom_bar(position="stack", stat="identity", show.legend=FALSE)+
  labs(y="Number of lengths/mt", x = "Year", title="Lengths/mt by Gear")+
  facet_grid(~gear~., scales="free")+
    scale_fill_viridis_d()+
  scale_color_viridis_d()+
  #   scale_color_manual(values=gear_colors)+
  # scale_fill_manual(values=gear_colors)+
    scale_y_continuous(n.breaks=3)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  theme_doc()

suppressWarnings(grid.arrange(fig7a, fig7b, nrow=1))

```


```{r fig11, warning=FALSE, message=FALSE, echo=FALSE, fig.width=6, fig.asp=1, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".11. The number of ",  params$name," otoliths collected per ton of catch by management area (left) or by gear (right). Note differences in scales. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}


#gear
fig8dat_b <- norage%>%
  filter(type_1_otolith=="Y") %>% 
  group_by(year, mgmt_area, gear) %>%
  summarize(n_otolith=n()) %>% 
  left_join(casdat%>%
              mutate(year=as.numeric(year))%>%
  group_by(year, gear) %>%
  summarize(catch_mt=sum(catch_mt)),
  by=c("year"="year", "gear"="gear"))%>%
  mutate(oratio=n_otolith/catch_mt)


#area
fig8a <-ggplot(fig8dat_a, aes(x=as.factor(year), y=oratio, fill= mgmt_area))+
  geom_bar(position="stack", stat="identity", show.legend=FALSE)+
  labs(y="Number otoliths/mt", x = "Year", title="Otoliths/mt by area")+
  facet_grid(~mgmt_area~., scales="free")+
    scale_fill_viridis_d()+
  scale_color_viridis_d()+
  # scale_color_manual(values=mgmt_colors)+
  # scale_fill_manual(values=mgmt_colors)+
  scale_y_continuous(n.breaks=3)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  theme_doc()
#gear
fig8b <-ggplot(fig8dat_b, aes(x=as.factor(year), y=oratio, fill= gear))+
  geom_bar(position="stack", stat="identity", show.legend=FALSE)+
  labs(y="Number otoliths/mt", x = "Year", title="Otoliths/mt by gear")+
    scale_fill_viridis_d()+
  scale_color_viridis_d()+
  # scale_color_manual(values=gear_colors)+
  # scale_fill_manual(values=gear_colors)+
  scale_y_continuous(n.breaks=3)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  facet_grid(~gear~., scales="free")+
  theme_doc()

grid.arrange(fig8a, fig8b, nrow=1) %>%
  suppressWarnings()

```


```{r fig12, warning=FALSE, message=FALSE, echo=FALSE, fig.asp=1.2, fig.width=6, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".12. The proportion of ",  params$name," lengths that were measured at-sea versus in ports by observers. At-sea sampling provides haul level information, while shoreshide is lower resolution trip level information. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}
norln<-norln%>%mutate(obs_source=recode_factor(monitoring_status,"AT_SEA_WITH_SALMON_CENSUS"="At-Sea", "AT_SEA"="At-Sea","TRAWL_EM_WITH_SHORESIDE"="Shoreside", "NO_MONITORING"="Shoreside"))

norln$obs_source2 <- addNA(norln$obs_source)
levels(norln$obs_source2) <- c(levels(norln$obs_source), "Unavailable")

fig9dat_a<-norln %>%
  mutate(year=as.character(year)) %>%
  group_by(year, mgmt_area, obs_source2) %>%
    summarize(n_length=sum(n_length))

    
fig9a <- ggplot(fig9dat_a,aes(x=as.factor(year),y=n_length,fill=obs_source2))+
  geom_bar(position="fill", stat="identity")+
  labs(y="Proportion", x = "Year", title="Proportion of Lengths by Area")+
  facet_grid(mgmt_area~.)+
    scale_fill_viridis_d()+
  scale_color_viridis_d()+
  #   scale_color_manual(values=c("#00467f","#BC4700","#4C9C2E"))+
  # scale_fill_manual(values=c("#00467f","#BC4700","#4C9C2E"))+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  scale_y_continuous(n.breaks=5)+
  theme_doc()

fig9a

```


```{r fig3, warning=FALSE, message=FALSE, echo=FALSE, fig.asp=1.2, fig.width=6, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".13. The proportion of ",  params$name," lengths that were measured at-sea versus in ports by observers. At-sea sampling provides haul level information, while shoreshide is lower resolution trip level information. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}


fig9dat_b<-norln %>%
  mutate(year=as.character(year)) %>%
  group_by(year, gear, obs_source2) %>%
    summarize(n_length=sum(n_length))
    


fig9b <- ggplot(fig9dat_b,aes(x=as.factor(year),y=n_length,fill=obs_source2))+
  geom_bar(position="fill", stat="identity")+
  labs(y="Proportion", x = "Year", title="Proportion of Lengths by Gear")+
  facet_grid(gear~.)+
    scale_fill_viridis_d()+
  scale_color_viridis_d()+
  #   scale_color_manual(values=c("#00467f","#BC4700","#4C9C2E"))+
  # scale_fill_manual(values=c("#00467f","#BC4700","#4C9C2E"))+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  scale_y_continuous(n.breaks=5)+
  theme_doc()

fig9b

```

```{r fig14,  warning=FALSE, message=FALSE, echo=FALSE, fig.asp=1.2, fig.width=6, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".14. The proportion of ",  params$name," catch with electronic monitoring (red) and the rate of length sampling (lengths per metric ton; black) for all gear types. Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY)")}

#https://finchstudio.io/blog/ggplot-dual-y-axes/
#for two y axes

fig10propEM <- casdat %>%
  filter(#gear %in% c("POT", "HAL") &
           obs_coverage == "EM Partial") %>%
  group_by(mgmt_area, year) %>%
  summarize(em_catch=sum(catch_mt)) %>%
  left_join(casdat %>%
  #filter(gear %in% c("POT", "HAL")) %>%
  group_by(mgmt_area, year) %>%
  summarize(total_catch=sum(catch_mt)),
  by=c("year"="year", "mgmt_area"="mgmt_area")) %>%
  mutate(prop_em=em_catch/total_catch,
         year=as.numeric(year)) 

fig10lnmt <- norln%>%
  #filter(gear %in% c("POT","HAL") ) %>%
  group_by(year, mgmt_area) %>%
  summarize(n_length=sum(n_length)) %>% 
  left_join(casdat%>%
              #filter(gear %in% c("POT","HAL")) %>%
              mutate(year=as.numeric(year))%>%
  group_by(year, mgmt_area) %>%
  summarize(catch_mt=sum(catch_mt)),
  by=c("year"="year", "mgmt_area"="mgmt_area"))%>%
  mutate(lratio=n_length/catch_mt)

scaleFUN <- function(x) sprintf("%.0f", x)

scale=10


suppressWarnings(
ggplot() +
  geom_line(data=fig10propEM, aes(x=year, y=prop_em, color="Catch with EM/Total Catch (mt)"), size=1)+
  geom_line(data=fig10lnmt, aes(x=year, y=lratio/scale, color="Lengths/mt"), size=1)+
  facet_wrap(~mgmt_area, ncol=1, scales="free_y")+
  scale_y_continuous(sec.axis = sec_axis(~.*scale, name="Lengths/mt")) +
  labs(x = "", y = "Catch with EM/Total Catch (mt)", color = "") +
  scale_color_manual(values = c("black", "red"))+
    scale_x_continuous(labels=scaleFUN, n.breaks=nyears)+
  theme_doc()
)

#try reversing y axes
# ggplot() +
#     geom_line(data=fig10lnmt, aes(x=year, y=lratio/scale, color="Lengths/mt"), size=1)+
#   geom_line(data=fig10propEM, aes(x=year, y=prop_em, color="Catch with EM/Total Catch (mt)"), size=1)+
#   facet_wrap(~mgmt_area, ncol=1, scales="free_y")+
#   scale_y_continuous(sec.axis = sec_axis(~.*scale, name="Catch with EM/Total Catch (mt)")) +
#   labs(x = "", y = "Lengths/mt", color = "") +
#   scale_color_manual(values = c("red", "black"))+
#     scale_x_continuous(labels=scaleFUN)+
#   theme_doc()
```


# Additional Information 

**Biological Collections**  

•	Lengths (mm), weight (tenth of a kg), and sagittal otoliths are collected by observers at-sea and at processing plants when North Pacific Groundfish Observer Program protocols call for collections. Otoliths are not collected from all fish that have lengths and weights recorded. Weights are collected when otoliths are collected.  

**Observer strata in the North Pacific Groundfish Observer Program**  

•	Full Coverage - Catcher/processors (with limited exceptions), motherships, catcher vessels that are participating in programs that have transferable prohibited species catch, catcher vessels using trawl gear that have requested full coverage for all fishing activity within the Bering Sea/Aleutian Islands FMP, and inshore processors receiving or processing Bering Sea pollock. Full coverage trips are all assumed to be 100% covered.  

•	Partial Coverage - Catcher vessels fishing in federally managed groundfish or parallel fisheries, excepting when in full coverage, catcher vessels participating in the Pacific halibut or sablefish IFQ fisheries, catcher vessels participating in the CDQ fisheries or those < 46ft LOA using hook-and-line gear for groundfish, catcher/processor that qualify for partial coverage, and shoreside or stationary floating processors that are not in the full coverage category are in the partial coverage category.   

•	EM - trawl gear: Trips in this strata have EM recordings and all are reviewed. The review is for compliance monitoring only and catch is not enumerated. Vessels operating in the trawl EM program are required to retain all catch (with limited exceptions) for shoreside sampling by observers at the plant. Shoreside observer sampling targets a 100% coverage rate of all EM - trawl deliveries in the BSAI and 30% in the GOA . This strata went into effect in 2020 as an Exempted Fishing Permit program, only on non-pelagic trawl vessels targeting Pollock, and is becoming regulated for the 2024 fishery.   

•	EM - fixed-gear: Includes both pot and hook-and-line vessels. Trips logged into ODDS have a partial coverage selection rate and, if selected, the vessel must record all hauls during that trip duration. After the videos are submitted, 30% of recorded hauls are reviewed and catch is fully censused along with discard status of each fish. There are no biological samples collected from fixed-gear EM trips.   

•	EM note - EM fixed gear is a completely different program from EM non-pelagic trawl, with different origins, directives and methodologies.  

•	No Coverage or Zero Selection - Vessels < 40ft LOA, jig and exempted vessels.  

**Caveats**  

•	Data prior to the 2013 North Pacific Observer Program restructure are not included in the analyses presented here due to structural changes.  

•	Not all observer strata were covered each year. For example, hook and line (HAL) tender was only covered in 2017, in which a total of four trips were made and thus deemed not a useful strata to include.   

•	2020 - Observer sampling was significantly impacted March-June due to the pandemic, resulting in minimal coverage during those months and reducing the annual realized coverage rates.   


# References
North Pacific Observe Program: https://www.fisheries.noaa.gov/alaska/fisheries-observers/north-pacific-observer-program

