---
title: "Appendix 19.A. Evaluation of stocks"
output: 
  word_document:
    keep_md: yes
    reference_docx: "StckAssess-format2.docx"
params: 
  name: "sablefish"
  name_cap: "Sablefish"
  cas: 710
  obs: 203
  chapter: "19"
  appendix: "A"
---

$$
\textbf{Cara Rodgveller, Cindy Tribuzio, Matt Callahan}
$$

$$
\textbf{`r Sys.Date()`}
$$


# Introduction

This report summarizes the fishery-dependent data observer data that are available and inform the Gulf of Alaska (GOA) and Bering Sea/Aleutian Islands (BSAI) 'r doc_name' stock assessment.
Logbook, eLandings and fish ticket data are not included here.
The format of this report is under development and should be considered a draft.
Data are queried from the Alaska Regional Office Catch Accounting System (CAS) and queried through AKFIN.
The results are based on total catch estimates and observer deployment information.
Due to minor differences in observer strata assignments between CAS and what vessels log into the Observer Declare and Deploy System the total catch estimates may be slightly different from those values reported in the North Pacific Observer Program Annual Reports.
Any differences are expected to be minor.
Data prior to the 2013 Observer Program Restructure are not included in the analyses presented here due to structural changes in the North Pacific Observer Program.

# Observer Deployment Performance

This section summarizes the projected and realized observer coverage rates since 2016 for all partial coverage trips (i.e., not specific to any fishery).
Observer strata are defined in the North Pacific Observer Program Annual Reports as follows: Full Coverage - catcher/processors (with limited exceptions), motherships, catcher vessels that are participating in programs that have transferable prohibited species catch, catcher vessels using trawl gear that have requested full coverage for all fishing activity within the BSAI and inshore processors receiving or processing Bering Sea pollock.
Partial Coverage - Catcher vessels fishing in federally managed groundfish or parallel fisheries, excepting when in full coverage, catcher vessels participating in the Pacific halibut or sablefish IFQ fisheries, catcher vessels participating in the CDQ fisheries or those \< 46ft LOA using hook-and-line gear for groundfish, catch/processors that qualify for partial coverage; and shoreside or stationary floating processors that are not in the full coverage category.
No Coverage/Selection - vessels \< 40ft LOA, jig and exempted vessels There are two Electronic Monitoring (EM) programs in effect: fixed-gear EM and trawl EM.
The fixed-gear EM program includes both pot and hook-and-line vessels.
Trips logged into ODDS for that program have a partial coverage selection rate, and if selected, the vessel must run the EM cameras for the trip duration.
After the videos are submitted, 30% of recorded hauls are reviewed and catch is fully censused.
There are no biological samples collected from fixed-gear EM trips.
Vessels operating in the trawl EM program record all trips and all of the videos are reviewed, however, the review is for compliance monitoring only.
Vessels operating in the trawl EM program are required to retain all catch (with limited exceptions) for shoreside sampling by observers at the plant.
For 2013 - 2015, the North Pacific Observer Program deployment strata included vessel level selection criteria and coverage rates are not comparable to current time series, therefore, not included in the table below.
Full Selection trips are all assumed to be 100% covered and not reported in the table below.
The Zero Selection trips are also not included.
Values are from the Annual Deployment Plans and the Annual Reports, available on the NPFMC website.
Not all observer strata were covered each year.
For example, Hook-and-line (HAL) tender was only covered in 2017, in which a total of four trips were made and thus deemed not a useful strata to include.
In 2020, observer sampling was significantly impacted March-June due to the pandemic, resulting in minimal coverage during those months and reducing the annual realized coverage rates.
The trawl EM EFP went into effect in 2020, in this strata all trips have 100% of video reviewed for compliance monitoring, and full retention is in effect.
Observer sampling occurs shoreside with the target of all Trawl EM EFP deliveries being observer sampled in the BSAI and 30% in the GOA.
The below table only documents partial coverage rates.

```{r load-packages, include=FALSE}
library(tidyverse)
library(odbc)
library(getPass)
library(lubridate)
library(janitor)
library(gridExtra)
library(flextable)

#This avoids scientific notation on plots
options(scipen = 999)
```

```{r connect-to-akfin, include=FALSE}

#connect to AKFIN
con <- dbConnect(odbc::odbc(), "akfin", UID=getPass(msg="USER NAME"), PWD=getPass())
```

```{r query-cas, include=FALSE}
# define time
startyear<-2013
endyear<-year(ymd(Sys.Date()))-1

#pull catch data
casdat<- dbFetch(dbSendQuery(con,
                           paste0("select year, week_end_date, wed, fmp_area,	fmp_subarea, reporting_area_code, agency_gear_code,
                       trip_target_group, trip_target_name, species_group_name, species_name, processor_permit_id,
                       ito_company processor_name, ito_plant processor_plant, ves_akr_adfg, ves_akr_name,	ves_akr_length,
                       retained_or_discarded, gf_harvest_sector, deployment_trip_start_date,	deployment_trip_end_date,
                       deployment_trip_pk, monitoring_status,	sampling_strata_deployment_category, sampling_strata,
                       sampling_strata_name, sampling_strata_selection_rate, management_program_code, sum(weight_posted) catch_mt
                from council.comprehensive_blend_ca
                where year >= 2013
                and year <= ", endyear, "
                and agency_species_code = '",noquote(params$cas),"'
                and (fmp_area = 'GOA' or fmp_area = 'BSAI')
                group by year, week_end_date, wed, fmp_area,	fmp_subarea, reporting_area_code, agency_gear_code,
                       trip_target_group, trip_target_name, species_group_name, species_name, processor_permit_id,
                       ito_company, ito_plant, ves_akr_adfg, ves_akr_name,	ves_akr_length,
                       retained_or_discarded, gf_harvest_sector, deployment_trip_start_date,	deployment_trip_end_date,
                       deployment_trip_pk, monitoring_status,	sampling_strata_deployment_category, sampling_strata,
                       sampling_strata_name, sampling_strata_selection_rate, management_program_code")))%>%
    clean_names()# %>% 
  #   group_by(year, week_end_date, wed, fmp_area,	fmp_subarea, reporting_area_code, agency_gear_code,
  #          trip_target_group, trip_target_name, species_group_name, species_name, processor_permit_id,
  #          processor_name, processor_plant, ves_akr_adfg, ves_akr_name,	ves_akr_length,
  #          retained_or_discarded, gf_harvest_sector, deployment_trip_start_date,	deployment_trip_end_date,
  #          deployment_trip_pk, monitoring_status,	sampling_strata_deployment_category, sampling_strata,
  #          sampling_strata_name, sampling_strata_selection_rate, management_program_code) %>% 
  # summarise(catch_mt = sum(weight_posted))

```

```{r process-cas, include=FALSE}


#process catch data for plotting
casdat <- casdat %>% 
  mutate(week_end_date = ymd(week_end_date),
         gear = agency_gear_code,
         mgmt_area=recode(fmp_subarea, "BS"="BS","AI"="AI","WG"="WGOA", "CG"="CGOA", "WY"="WY", "SE"="EY"),
         # mgmt_area = if_else(fmp_subarea == "BS", "BS",
         #                     if_else(fmp_subarea == "AI", "AI",
         #                             if_else(fmp_subarea == "WG", "WGOA",
         #                                     if_else(fmp_subarea == "CG", "CGOA", "EGOA")))),
         obs_coverage = if_else(sampling_strata_name == "No Selection", "None",
                                if_else(sampling_strata_name == "Full Selection" |
                                          sampling_strata_name == "Trawl EM Full Coverage Selection", "Full",
                                        if_else(sampling_strata_name == "EM Hook-and-Line Trip Selection" |
                                                  sampling_strata_name == "EM Pot Trip Selection" |
                                                  sampling_strata_name == "EM Pot Tender Trip Selection" |
                                                  sampling_strata_name == "Trawl EM Partial Coverage Selection", "EM Partial",
                                                if_else(sampling_strata_name == "Trawl EM Full Coverage Selection", "EM Full", "Partial")))),
         observed = if_else(monitoring_status == "FIXED_GEAR_EM", "Catch Only",
                            if_else(monitoring_status == "NO_MONITORING", "None","Catch/Biologicals")))

         # obs_coverage=recode(sampling_strata_name, "No Selection"="None",
         #                     "Full Selection"="Full", 
         #                     "Trawl EM Full Coverage Selection"="Full",
         #                     "EM Hook-and-Line Trip Selection"="EM Partial", 
         #                     "EM Pot Trip Selection"="EM Partial",
         #                     "EM Pot Tender Trip Selection"="EM Partial" ,
         #                     "Trawl EM Partial Coverage Selection"="EM Partial",
         #                     "Trawl EM Full Coverage Selection" = "EM Full", 
         #                     "Pot Trip Selection" = "Partial",
         #                     ),

#set plotting orders
casdat$mgmt_area <- factor(casdat$mgmt_area, 
                               levels = c("AI", "BS", "WGOA", "CGOA", "WY", "EY"))
casdat$gear <- factor(casdat$gear, 
                               levels = c("PTR", "NPT", "POT", "HAL", "JIG"))

```

```{r query-norpac-length, include=FALSE}
#pull obs length data
#pull catch data
norln<- dbFetch(dbSendQuery(con,
                           paste0("select species, nmfs_area,  year, akr_gear, fmp_area, fmp_subarea, sampling_strata_name, monitoring_status, sum(frequency) n_length
                from NORPAC.debriefed_length_mv
                where YEAR >= 2013
                 and year <= ", endyear, "
                and FMP_AREA in ('GOA','BSAI')
                and SPECIES = '",noquote(params$obs),"'
                group by species, nmfs_area,  year, akr_gear, fmp_area, fmp_subarea, sampling_strata_name, monitoring_status")))
               

norln <- norln %>% 
  rename_with(tolower) %>%
  #Is there a reason we filtered on nmfs area here and fmp_area for cas?
  #filter(nmfs_area != 649) %>% 
  mutate(gear = akr_gear,
         mgmt_area=recode(fmp_subarea, "BS"="BS","AI"="AI","WG"="WGOA", "CG"="CGOA", "WY"="WY", "SE"="EY"),
         obs_coverage = if_else(sampling_strata_name == "No Selection", "None",
                                if_else(sampling_strata_name == "Full Selection" |
                                          sampling_strata_name == "Trawl EM Full Coverage Selection", "Full",
                                        if_else(sampling_strata_name == "EM Hook-and-Line Trip Selection" |
                                                  sampling_strata_name == "EM Pot Trip Selection" |
                                                  sampling_strata_name == "EM Pot Tender Trip Selection" |
                                                  sampling_strata_name == "Trawl EM Partial Coverage Selection", "EM Partial",
                                                if_else(sampling_strata_name == "Trawl EM Full Coverage Selection", "EM Full", "Partial")))),
         observed = if_else(monitoring_status == "FIXED_GEAR_EM", "Catch Only",
                            if_else(monitoring_status == "NO_MONITORING", "None","Catch/Biologicals")))


#set plotting orders
norln$mgmt_area <- factor(norln$mgmt_area, 
                               levels = c("AI", "BS", "WGOA", "CGOA", "WY", "EY"))
norln$gear <- factor(norln$gear, 
                               levels = c("PTR", "NPT",  "POT", "HAL", "JIG"))

```

```{r query-norpac-age, include=FALSE}
#pull obs length data
norage <- dbFetch(dbSendQuery(con,
                           paste0("
                select join_key, species_key, cruise, permit, vessel, gear, nmfs_area, specimen_number, Type_1_otolith, type_3_sex_length_weight, year,
                       gear_description, akr_gear, fmp_gear, fmp_area, fmp_subarea, species_name, akr_species_codes, deployment_trip_pk,
                       sampling_strata, sampling_strata_name, sampling_strata_deployment_category, sampling_strata_selection_rate, monitoring_status
                from NORPAC.debriefed_age_flat_mv
                where year >= 2013
                 and year <= ", endyear, "
                and species = '",params$obs,"'
                and fmp_area in ('GOA', 'BSAI')"
                ))) %>%
  clean_names()
               

norage <- norage %>% 
  #Is there a reason we filtered on nmfs area here and fmp_area for cas?
  #filter(nmfs_area != 649) %>% 
  mutate(gear = akr_gear,
         mgmt_area=recode(fmp_subarea, "BS"="BS","AI"="AI","WG"="WGOA", "CG"="CGOA", "WY"="WY", "SE"="EY"),
         obs_coverage = if_else(sampling_strata_name == "No Selection", "None",
                                if_else(sampling_strata_name == "Full Selection" |
                                          sampling_strata_name == "Trawl EM Full Coverage Selection", "Full",
                                        if_else(sampling_strata_name == "EM Hook-and-Line Trip Selection" |
                                                  sampling_strata_name == "EM Pot Trip Selection" |
                                                  sampling_strata_name == "EM Pot Tender Trip Selection" |
                                                  sampling_strata_name == "Trawl EM Partial Coverage Selection", "EM Partial",
                                                if_else(sampling_strata_name == "Trawl EM Full Coverage Selection", "EM Full", "Partial")))),
         observed = if_else(monitoring_status == "FIXED_GEAR_EM", "Catch Only",
                            if_else(monitoring_status == "NO_MONITORING", "None","Catch/Biologicals")))


#set plotting orders
norage$mgmt_area <- factor(norage$mgmt_area, 
                               levels = c("AI", "BS", "WGOA", "CGOA", "WY", "EY"))
norage$gear <- factor(norage$akr_gear, 
                               levels = c("PTR", "NPT", "POT", "HAL", "JIG"))

```

\newpage


# Tables

```{r warning=FALSE, message=FALSE, echo=FALSE}
# Note that the report was originally written with figure specific data subsets that were then used for tables. 

#divide into retained and discarded
fig1dat<-casdat %>% 
  filter(retained_or_discarded=="R") %>%
  group_by(year, mgmt_area, gear, retained_or_discarded) %>% 
  summarise(catch_mt = sum(catch_mt)) %>%
  bind_rows(casdat %>% 
  filter(retained_or_discarded=="D") %>%
  group_by(year, mgmt_area, gear, retained_or_discarded) %>% 
  summarise(catch_mt = sum(catch_mt))) %>%
  bind_rows(casdat %>% 
  group_by(year, mgmt_area, gear) %>% 
  summarise(catch_mt = sum(catch_mt)) %>%
    mutate(retained_or_discarded="Both") %>%
    dplyr::select(year, mgmt_area, gear, retained_or_discarded, catch_mt)) %>%
  mutate(retained_or_discarded=recode_factor(retained_or_discarded, "Both"="Total", "R"="Retained", "D"="Discarded"))

#make table of catch by gear and area
fig1sum<-fig1dat %>%
  filter(retained_or_discarded=="Total") %>%
  group_by(mgmt_area, year) %>%
  summarize(Sum=round(sum(catch_mt),0)) %>%
  mutate(Sum=as.character(Sum),
         Sum=recode_factor(Sum, "0"="<1"))

#gsub('^(.{1})(.*)$', '\\1,\\2', "1000")

fig1dat%>%
  filter(retained_or_discarded=="Total") %>%
  mutate(catch_mt=round(catch_mt,0),
         catch_mt=as.character(catch_mt),
         catch_mt=recode_factor(catch_mt, "0"="<1"),
         catch_mt=as.character(catch_mt),
         #the next line is that there are commas in the output numbers
         catch_mt=ifelse(nchar(catch_mt)<=3, catch_mt,
                         paste0(substring(catch_mt, 1, nchar(catch_mt) - 3),
                          ",",
                          substring(catch_mt, nchar(catch_mt) - 2, nchar(catch_mt)))),
         Year=year,
         Area=mgmt_area) %>%
  dplyr::select(Area, Year,  gear, catch_mt) %>%
  pivot_wider(id_cols=c(Area, Year), names_from=gear, values_from=catch_mt) %>%
  left_join(fig1sum, by=c("Area"="mgmt_area", "Year"="year")) %>%
  arrange(Area, Year) %>%
  flextable() %>%
  align(j = c("NPT","HAL", "POT", "HAL", "Sum"), align = "right") %>%
  set_caption(caption=paste0("Table ", params$chapter, ".", params$appendix, ".1. Total ", params$name, " catch (mt) by area, year, and gear. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY)."))

```


\newpage


```{r warning=FALSE, message=FALSE, echo=FALSE}
#summarize norpac length data
fig5dat<-norln%>%
  group_by(year, mgmt_area, gear) %>%
  summarize(n_length=sum(n_length))

#summarize without gear calculating proportions
lnsum<-fig5dat %>%
  group_by(mgmt_area, year) %>%
  summarize(Sum=round(sum(n_length),0))

#create table
fig5dat%>%
  mutate(Year=year,
         Area=mgmt_area) %>%
  dplyr::select(Area, Year,  gear, n_length) %>%
  pivot_wider(id_cols=c(Area, Year), names_from=gear, values_from=n_length) %>%
   left_join(lnsum, by=c("Area"="mgmt_area", "Year"="year")) %>%
  mutate(Year=as.factor(Year)) %>%
   arrange(Area, Year) %>%
  flextable() %>%
  set_caption(caption=paste0("Table ", params$chapter, ".", params$appendix, ".2. Count of  ",params$name, " lengths measured by at-sea and port observers by area, year, and gear. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY)."))
```



\newpage



```{r warning=FALSE, message=FALSE, echo=FALSE}
#summarize data
fig6dat<-norage%>%
  filter(type_1_otolith=="Y") %>% 
  group_by(year, mgmt_area, gear) %>%
  summarize(n_otolith=n())

#summarize without gear for proportion
osum<-fig6dat %>%
  group_by(mgmt_area, year) %>%
  summarize(Sum=round(sum(n_otolith),0))

#create table
fig6dat%>%
  mutate(Year=year,
         Area=mgmt_area) %>%
  dplyr::select(Area, Year,  gear, n_otolith) %>%
  pivot_wider(id_cols=c(Area, Year), names_from=gear, values_from=n_otolith) %>%
  left_join(osum, by=c("Area"="mgmt_area", "Year"="year")) %>%
    mutate(Year=as_factor(Year)) %>%
     arrange(Area, Year) %>%
  flextable() %>%
  set_caption(caption=paste0("Table ", params$chapter, ".", params$appendix, ".3. Count of  ",params$name, " otoliths measured by at-sea and port observers by area, year, and gear. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY)."))

```



\newpage



# Figures

```{r fig1, warning=FALSE, message=FALSE, echo=FALSE, fig.width=6, fig.asp=1, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".1. ", params$name_cap ," catch by gear type that was either retained, discarded, or the sum of retained and discarded by management area. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}


theme_doc<- function(base_size = 12, base_family = "Arial") { #this function sets the theme for the whole figure
  theme_bw(base_size = base_size, base_family = base_family) %+replace% #also note that this creates a bunch of font warnings that are not a real problem, I just haven't dealt with it yet
#  theme_bw()+
    theme(
      plot.title=element_text(size=12,colour='black',hjust = 0.5, vjust=1),
      plot.background=element_blank(),
      panel.grid = element_blank(),
      panel.grid.minor=element_blank(),
      panel.grid.major.x=element_blank(),
      panel.grid.major.y=element_line(color="grey90"),
      panel.border = element_blank(),
      panel.background = element_blank(),
      axis.line.x = element_line(colour='black'),
      axis.line.y = element_line(colour='black'),
      axis.text=element_text(size=10,colour='black'),
      axis.ticks.y=element_line(colour='black'),
      axis.ticks.x=element_blank(),
      axis.title.y=element_text(colour='black',angle=90, vjust=2.5),
      axis.title.x=element_text(colour='black'),
      legend.background=element_blank(),
      legend.text=element_text(colour='black',size=10),
      legend.title=element_blank(),
      legend.position = "bottom",
      strip.background=element_blank(),
      strip.text=element_text(size=10,colour='black'),
      axis.text.x = element_text(angle = 45, hjust=1, vjust=1.1)
    )
}

mgmt_colors<-c("#B2282E","#575195","#BC4700","#4C9C2E","#00467f","#1ECAD3")

gear_colors<-c("#93D500", "#007934","#FF8300", "#0093D0","#7F7FFF")


  ggplot(fig1dat, aes(x=as.factor(year), y=catch_mt/1000, 
                               fill = gear, color = gear))+
  geom_bar(position = position_stack(), stat = "identity", show.legend = T, width=1)+
  facet_grid(rows=vars(mgmt_area), cols=vars(retained_or_discarded))+
  labs(x = "Year", y = "Catch (thousand mt)")+
  scale_color_manual(values=gear_colors)+
  scale_fill_manual(values=gear_colors)+
  #scale_y_continuous(expand = expansion(mult = c(0, 0.05)))+
  scale_y_continuous(n.breaks=4)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  theme_doc()



```

\newpage

```{r fig2, warning=FALSE, message=FALSE, echo=FALSE, fig.width=6, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".2. Proportion of fixed gear ", params$name," catch in pots in the Gulf of Alaska (dashed line), the Bering Sea and Aleutian Islands (dotted line), and both combined (solid line). Jig gear is excluded.")}
#process data
fig2dat<-casdat%>%
  #filter to fixed gear
  filter(gear %in% c("HAL", "POT")) %>%
  #calculate total for all fixed gear
  group_by(year, fmp_area) %>%
  summarize(fixed_gear_catch=sum(catch_mt)) %>%
  #add column for pot gear only
  left_join(casdat%>%
  #filter to pot
  filter(gear == "POT") %>%
  #calculate total for pot
  group_by(year, fmp_area) %>%
  summarize(pot_catch=sum(catch_mt)), 
  by=c("year"="year", "fmp_area"="fmp_area")) %>%
  mutate(prop_pot=pot_catch/fixed_gear_catch)


fig2<-ggplot()+
  geom_line(data=fig2dat%>%filter(fmp_area=="BSAI"), aes(x=as.numeric(year), y=prop_pot), size=1, lty=3)+
    geom_line(data=fig2dat%>%filter(fmp_area=="GOA"), aes(x=as.numeric(year), y=prop_pot), size=1, lty=2)+
  geom_line(data=fig2dat%>%group_by(year) %>% 
              summarize(fixed_gear_catch=sum(fixed_gear_catch),
                        pot_catch=sum(pot_catch)) %>% 
              mutate(prop_pot=pot_catch/fixed_gear_catch), 
            aes(x=as.numeric(year), y=prop_pot), size=1, lty=1)+
  #facet_wrap(~fmp_area)+
  scale_x_continuous(breaks = seq(startyear, endyear, by = 1))+
  ylim(c(0,1))+
  xlab("Year")+ ylab("Pot proportion")+
  ggtitle("Proportion of Fixed Gear Catch in Pots")+
  theme_doc()+
  theme(plot.title = element_text(hjust = 0.5))
suppressWarnings(fig2)
```

\newpage

```{r fig3, warning=FALSE, message=FALSE, echo=FALSE, fig.asp=1.2, fig.width=6, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".3. ",params$name_cap," catch in each observer coverage category in the Observer Deploy and Declare System (ODDS), including fixed gear electronic monitoring (EM). This catch was not necessarily observed. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}
#set plotting order
casdat$obs_coverage<-factor(casdat$obs_coverage, levels = c("Partial", "EM Partial", "Full", "None"))

coverage_colors<-c("#625BC4","#FF8300","#4C9C2E","#FF4438")

#filter data
fig3dat<-casdat %>% 
  group_by(year, mgmt_area, obs_coverage, gear) %>% 
  summarise(catch_mt = sum(catch_mt)) %>% 
  inner_join(casdat %>% 
  group_by(year, mgmt_area) %>% 
  summarise(totcatch = sum(catch_mt)), by = c("year", "mgmt_area")) %>% 
  mutate(prop_catch = catch_mt/totcatch) %>% 
  filter(gear != "JIG")

fig3a <- ggplot(fig3dat, aes(x=as.factor(year), y=totcatch/10000, fill=obs_coverage, color=obs_coverage))+
  geom_bar(position = position_stack(), stat = "identity", show.legend=FALSE, width=1)+
  facet_grid(mgmt_area~gear)+
  labs(x = "Year", y = "Catch (ten thousand mt)")+
  scale_color_manual(values=coverage_colors)+
  scale_fill_manual(values=coverage_colors)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 4))+
    scale_y_continuous(n.breaks=3)+
  theme_doc()

fig3b <- ggplot(fig3dat, aes(x=as.factor(year), y=prop_catch, fill=obs_coverage, color=obs_coverage))+
  geom_bar(position = position_fill(), stat = "identity", width=1)+
  facet_grid(mgmt_area~gear)+
  labs(x = "Year", y = "Proportion")+
  scale_y_continuous(breaks=c(0,0.5,1))+
  scale_color_manual(values=coverage_colors)+
  scale_fill_manual(values=coverage_colors)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  theme_doc()
grid.arrange(fig3a, fig3b, nrow=2)

  
```


```{r fig4, warning=FALSE, message=FALSE, echo=FALSE, fig.width=6, fig.asp=1.2, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".4. ",params$name_cap," catch by gear type either observed by electronic monitoring (EM), observers, or no coverage. Biological samples were not taken whenever an observer was present. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}
#biol_colors<-c("#625BC4","#AAD7DD","#D02C2F" )
biol_colors<-c("#575195","#1ECAD3","#FF8300")
  
areagear_tot <- casdat %>% 
  filter(gear != "JIG") %>% 
  group_by(year, mgmt_area, gear) %>% 
  summarise(totcatch = sum(catch_mt))

obs_prop <- casdat %>% 
  filter(agency_gear_code != "JIG") %>% 
  group_by(year, mgmt_area, observed, gear) %>% 
  summarise(catch_mt = sum(catch_mt)) %>% 
  inner_join(areagear_tot, by = c("year", "mgmt_area","gear")) %>% 
  mutate(prop_catch = catch_mt/totcatch,
         Coverage = recode(observed, "Catch Only"="EM", "Catch/Biologicals"="Observer", "None"="No Coverage"))

obs_prop$Coverage<- factor(obs_prop$Coverage, levels=c("EM","Observer","No Coverage"))

fig4a <- ggplot(obs_prop, aes(x=as.factor(year), y=catch_mt/1000, fill=Coverage, color=Coverage))+
  geom_bar(position = position_stack(), stat = "identity", width=1)+
    scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  facet_grid(mgmt_area~gear)+
  labs(x = "Year", y = "Catch (thousand mt)")+
  scale_y_continuous(n.breaks=3)+
  scale_color_manual(values=biol_colors)+
  scale_fill_manual(values=biol_colors)+
  theme_doc()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

fig4b <- ggplot(obs_prop, aes(x=as.factor(year), y=prop_catch, fill=Coverage, color=Coverage))+
  geom_bar(position = position_stack(), stat = "identity", width=1)+
    scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  facet_grid(mgmt_area~gear)+
  labs(x = "Year", y = "Proportion")+
  scale_y_continuous(breaks=c(0,1))+
  scale_color_manual(values=biol_colors)+
  scale_fill_manual(values=biol_colors)+
  theme_doc()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom")
suppressWarnings(grid.arrange(fig4a, fig4b, nrow=2))
```



```{r fig5, warning=FALSE, message=FALSE, echo=FALSE, fig.asp=1.2, fig.width=6, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".5. The total and proportion of ",params$name," lengths collected by observers by gear and area. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}
#plot 

#numbers
fig5_lnum <-ggplot(fig5dat,aes(x=as.factor(year),y=n_length/1000,fill=gear))+
  geom_bar(position="stack", stat="identity", show.legend = F)+
  labs(y="Thousands of lengths collected", x = "Year", title="Lengths Collected")+
    scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
    scale_color_manual(values=gear_colors)+
  scale_fill_manual(values=gear_colors)+
  facet_grid(mgmt_area~.)+
  theme_doc()+
  theme(legend.position="none")
#proportion
fig5_lprop <- ggplot(fig5dat,aes(x=as.factor(year),y=n_length,fill=gear))+
  geom_bar(position="fill", stat="identity")+
  labs(y="Proportion", x = "Year", title="Proportion of Total Lengths")+
  facet_grid(mgmt_area~.)+
    scale_color_manual(values=gear_colors)+
  scale_fill_manual(values=gear_colors)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  scale_y_continuous(breaks=c(0,1))+
  theme_doc()+
  theme(legend.position="bottom")

suppressWarnings(grid.arrange(fig5_lnum, fig5_lprop, nrow=2))

```



```{r fig6, warning=FALSE, message=FALSE, echo=FALSE, fig.asp=1.2, fig.width=6, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".6. The number of otoliths collected by observers and the proportion of ", params$name," otoliths collected by gear and area. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}

#plot 

#numbers
fig6_anum <-ggplot(fig6dat,aes(x=as.factor(year),y=n_otolith/1000,fill=gear))+
  geom_bar(position="stack", stat="identity", show.legend = F)+
  labs(y="Otoliths Collected (thousands)", x = "Year", title="Sampled Otoliths")+
  facet_grid(mgmt_area~.)+
  scale_color_manual(values=gear_colors)+
  scale_fill_manual(values=gear_colors)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  scale_y_continuous(n.breaks=3)+
  theme_doc()
#proportion
fig6_aprop <- ggplot(fig6dat,aes(x=as.factor(year),y=n_otolith,fill=gear))+
  geom_bar(position="fill", stat="identity")+
  labs(y="Proportion", x = "Year", title="Proportion of Total Otoliths")+
  facet_grid(mgmt_area~.)+
  scale_color_manual(values=gear_colors)+
  scale_fill_manual(values=gear_colors)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  scale_y_continuous(breaks=c(0,1))+
  theme_doc()+
  theme(legend.position = "bottom")

suppressWarnings(grid.arrange(fig6_anum, fig6_aprop, nrow=2))

```



```{r fig7, warning=FALSE, message=FALSE, echo=FALSE, fig.width=6,  fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".7. The number of ",  params$name," lengths collected per ton of catch by management area (left) or by gear (right). Note differences in scales. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}
#mgmt area
fig7dat_a <- norln%>%
  group_by(year, mgmt_area) %>%
  summarize(n_length=sum(n_length)) %>% 
  left_join(casdat%>%
              mutate(year=as.numeric(year))%>%
  group_by(year, mgmt_area) %>%
  summarize(catch_mt=sum(catch_mt)),
  by=c("year"="year", "mgmt_area"="mgmt_area"))%>%
  mutate(lratio=n_length/catch_mt)

#gear
fig7dat_b <- norln%>%
  group_by(year, gear) %>%
  summarize(n_length=sum(n_length)) %>% 
  left_join(casdat%>%
              mutate(year=as.numeric(year))%>%
  group_by(year, gear) %>%
  summarize(catch_mt=sum(catch_mt)),
  by=c("year"="year", "gear"="gear"))%>%
  mutate(lratio=n_length/catch_mt)


#area
fig7a <-ggplot(fig7dat_a, aes(x=as.factor(year), y=lratio, fill= mgmt_area))+
  geom_bar(position="stack", stat="identity", show.legend=FALSE)+
  labs(y="Number of lengths/mt", x = "Year", title="Lengths/mt by Area")+
  facet_grid(~mgmt_area~., scales="free")+
    scale_color_manual(values=mgmt_colors)+
  scale_fill_manual(values=mgmt_colors)+
    scale_y_continuous(n.breaks=2)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  theme_doc()
#gear
fig7b <-ggplot(fig7dat_b, aes(x=as.factor(year), y=lratio, fill= gear))+
  geom_bar(position="stack", stat="identity", show.legend=FALSE)+
  labs(y="Number of lengths/mt", x = "Year", title="Lengths/mt by Gear")+
  facet_grid(~gear~., scales="free")+
    scale_color_manual(values=gear_colors)+
  scale_fill_manual(values=gear_colors)+
    scale_y_continuous(n.breaks=2)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  theme_doc()

suppressWarnings(grid.arrange(fig7a, fig7b, nrow=1))

```

\newpage

```{r fig8, warning=FALSE, message=FALSE, echo=FALSE, fig.width=6, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".8. The number of ",  params$name," otoliths collected per ton of catch by management area (left) or by gear (right). Note differences in scales. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}
#mgmt area
fig8dat_a <- norage%>%
  filter(type_1_otolith=="Y") %>% 
  group_by(year, mgmt_area) %>%
  summarize(n_otolith=n()) %>% 
  left_join(casdat%>%
              mutate(year=as.numeric(year))%>%
  group_by(year, mgmt_area) %>%
  summarize(catch_mt=sum(catch_mt)),
  by=c("year"="year", "mgmt_area"="mgmt_area"))%>%
  mutate(oratio=n_otolith/catch_mt)

#gear
fig8dat_b <- norage%>%
  filter(type_1_otolith=="Y") %>% 
  group_by(year, mgmt_area, gear) %>%
  summarize(n_otolith=n()) %>% 
  left_join(casdat%>%
              mutate(year=as.numeric(year))%>%
  group_by(year, gear) %>%
  summarize(catch_mt=sum(catch_mt)),
  by=c("year"="year", "gear"="gear"))%>%
  mutate(oratio=n_otolith/catch_mt)


#area
fig8a <-ggplot(fig8dat_a, aes(x=as.factor(year), y=oratio, fill= mgmt_area))+
  geom_bar(position="stack", stat="identity", show.legend=FALSE)+
  labs(y="Number otoliths/mt", x = "Year", title="Otoliths/mt by area")+
  facet_grid(~mgmt_area~., scales="free")+
  scale_color_manual(values=mgmt_colors)+
  scale_fill_manual(values=mgmt_colors)+
  scale_y_continuous(n.breaks=2)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  theme_doc()
#gear
fig8b <-ggplot(fig8dat_b, aes(x=as.factor(year), y=oratio, fill= gear))+
  geom_bar(position="stack", stat="identity", show.legend=FALSE)+
  labs(y="Number otoliths/mt", x = "Year", title="Otoliths/mt by gear")+
  scale_color_manual(values=gear_colors)+
  scale_fill_manual(values=gear_colors)+
  scale_y_continuous(n.breaks=2)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  facet_grid(~gear~., scales="free")+
  theme_doc()

grid.arrange(fig8a, fig8b, nrow=1) %>%
  suppressWarnings()

```

\newpage

```{r fig9, warning=FALSE, message=FALSE, echo=FALSE, fig.asp=1.2, fig.width=6, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".9. The proportion of ",  params$name," lengths that were measured at-sea versus in ports by observers. At-sea sampling provides haul level information, while shoreshide is lower resolution trip level information. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}
norln<-norln%>%mutate(obs_source=recode_factor(monitoring_status,"AT_SEA_WITH_SALMON_CENSUS"="At-Sea", "TRAWL_EM_WITH_SHORESIDE"="Shoreside", "NO_MONITORING"="Shoreside"))

fig9dat_a<-norln %>%
  mutate(year=as.character(year)) %>%
  group_by(year, mgmt_area, obs_source) %>%
    summarize(n_length=sum(n_length))

fig9dat_b<-norln %>%
  mutate(year=as.character(year)) %>%
  group_by(year, gear, obs_source) %>%
    summarize(n_length=sum(n_length))
    
fig9a <- ggplot(fig9dat_a,aes(x=as.factor(year),y=n_length,fill=obs_source))+
  geom_bar(position="fill", stat="identity", show.legend=FALSE)+
  labs(y="Proportion", x = "Year", title="Proportion of Lengths by Area")+
  facet_grid(mgmt_area~.)+
    scale_color_manual(values=c("#00467f","#BC4700","#4C9C2E"))+
  scale_fill_manual(values=c("#00467f","#BC4700","#4C9C2E"))+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  scale_y_continuous(n.breaks=2)+
  theme_doc()

fig9b <- ggplot(fig9dat_b,aes(x=as.factor(year),y=n_length,fill=obs_source))+
  geom_bar(position="fill", stat="identity")+
  labs(y="Proportion", x = "Year", title="Proportion of Lengths by Gear")+
  facet_grid(gear~.)+
    scale_color_manual(values=c("#00467f","#BC4700","#4C9C2E"))+
  scale_fill_manual(values=c("#00467f","#BC4700","#4C9C2E"))+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  scale_y_continuous(n.breaks=2)+
  theme_doc()

grid.arrange(fig9a, fig9b, nrow=2)

```



```{r eval=FALSE, include=FALSE, warning=FALSE, message=FALSE, echo=FALSE, fig.asp=1.2, fig.width=6, fig.cap=paste0("Figure 10. The proportion of ",  params$name," catch by observer coverage (left) and number of lengths collected per metric ton of catch (right). Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}
fig10a<-ggplot(data=casdat, aes(x=as.factor(year),y=catch_mt, fill=obs_coverage))+
  geom_bar(position="fill", stat="identity")+
    labs(y="Proportion", x = "Year", title="Proportion catch by coverage")+
  facet_grid(mgmt_area~.)+
    scale_color_manual(values=coverage_colors)+
  scale_fill_manual(values=coverage_colors)+
  scale_x_discrete(breaks = seq(startyear, endyear, by = 3))+
  theme_doc()

fig10bdat <- norln%>%
  filter(gear %in% c("POT","HAL")) %>%
  group_by(year, mgmt_area) %>%
  summarize(n_length=sum(n_length)) %>% 
  left_join(casdat%>%
              filter(gear %in% c("POT","HAL")) %>%
              mutate(year=as.numeric(year))%>%
  group_by(year, mgmt_area) %>%
  summarize(catch_mt=sum(catch_mt)),
  by=c("year"="year", "mgmt_area"="mgmt_area"))%>%
  mutate(lratio=n_length/catch_mt)

fig10b<-ggplot(data=fig10bdat, aes(x=year,y=lratio))+
  geom_line(size=1)+
  facet_grid(mgmt_area~., scales="free")+
      labs(y="lengths/mt", x = "Year", title="Lengths per mt in pot and HAL fisheries")+
#    scale_color_manual(values=coverage_colors)+
#  scale_fill_manual(values=coverage_colors)+
  scale_x_continuous(breaks = seq(startyear, endyear, by = 3))+
  theme_doc()

grid.arrange(fig10a, fig10b, nrow=2)

  
```

```{r fig10,  warning=FALSE, message=FALSE, echo=FALSE, fig.asp=1.2, fig.width=6, fig.cap=paste0("Figure ", params$chapter, ".", params$appendix, ".10. The proportion of ",  params$name," fixed gear catch with electronic monitoring (black) and the rate of length sampling (lengths per metric ton; red). Values are scaled to a mean of zero for comparison. Gear types include pelagic trawl (PTR), non-pelagic trawl (NPT), pot (POT), or hook and line (HAL). Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).")}

fig10propEM <- casdat %>%
  filter(gear %in% c("POT", "HAL") &
           obs_coverage == "EM Partial") %>%
  group_by(mgmt_area, year) %>%
  summarize(em_catch=sum(catch_mt)) %>%
  left_join(casdat %>%
  filter(gear %in% c("POT", "HAL")) %>%
  group_by(mgmt_area, year) %>%
  summarize(total_catch=sum(catch_mt)),
  by=c("year"="year", "mgmt_area"="mgmt_area")) %>%
  mutate(prop_em=em_catch/total_catch,
         year=as.numeric(year)) %>%
  group_by(mgmt_area) %>%
  mutate(prop_em_scaled=scale(prop_em)) %>%
  ungroup()

fig10lnmt <- norln%>%
  filter(gear %in% c("POT","HAL") ) %>%
  group_by(year, mgmt_area) %>%
  summarize(n_length=sum(n_length)) %>% 
  left_join(casdat%>%
              filter(gear %in% c("POT","HAL")) %>%
              mutate(year=as.numeric(year))%>%
  group_by(year, mgmt_area) %>%
  summarize(catch_mt=sum(catch_mt)),
  by=c("year"="year", "mgmt_area"="mgmt_area"))%>%
  mutate(lratio=n_length/catch_mt)%>%
  group_by(mgmt_area) %>%
  mutate(lratio_scaled=scale(lratio))%>%
  ungroup()

scaleFUN <- function(x) sprintf("%.0f", x)

ggplot()+
  geom_line(data=fig10propEM, aes(x=year, y=prop_em_scaled, color="black"), size=1)+
  geom_line(data=fig10lnmt, aes(x=year, y=lratio_scaled, color="red"), size=1)+
  facet_wrap(~mgmt_area, ncol=1)+
  scale_colour_manual(name="",  values=c('black'='black', 'red'='red'), labels=c("Proportion EM","Lengths/mt"))+
  ylab("Scaled Lengths/mt and Proportion Catch with EM")+
  xlab("")+
  theme_doc()+
  scale_x_continuous(labels=scaleFUN)


```



![Figure 12. Map of Fisheries Management Plan subareas. Areas include the Aleutian Islands (AI), Bering Sea (BS), Western Gulf of Alaska (WGOA), Central Gulf of Alaska (CGOA), West Yakutat (WY), and East Yakutat (EY).](fmp_subarea.png)
